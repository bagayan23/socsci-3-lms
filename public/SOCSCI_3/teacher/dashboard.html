<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Portal - SOCSCI-3</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header>
        <div style="display:flex; align-items:center;">
            <i class="fas fa-bars burger-menu"></i>
            <h1>SOCSCI-3 Teacher Portal</h1>
        </div>
        <div class="header-user-menu">
            <div class="user-avatar" id="user-avatar">
                <div class="spinner"></div>
            </div>
            <div class="dropdown-menu">
                <a href="edit_profile.html"><i class="fas fa-user-edit"></i> Edit Account</a>
                <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </header>
    
    <div class="dashboard-layout">
        <div class="sidebar">
            <nav>
                <ul>
                    <li><a href="dashboard.html">Home</a></li>
                    <li><a href="students.html">Students</a></li>
                    <li><a href="activity.html">Activity</a></li>
                    <li><a href="resources.html">Resources</a></li>
                    <li><a href="courses.html">Courses</a></li>
                </ul>
            </nav>
        </div>
        <div class="main-content">

<div style="margin-bottom: 2rem; display: flex; align-items: center; gap: 1.5rem;">
    <div style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; border: 3px solid var(--primary-color); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); flex-shrink: 0;">
        <div id="profile-avatar" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary-color), #818cf8); color: white; font-size: 2rem; font-weight: 600;">
        </div>
    </div>
    <div>
        <h2 style="margin: 0 0 0.5rem 0; color: var(--text-color); display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-chalkboard-teacher" style="color: var(--primary-color);"></i>
            Welcome back, <span id="user-name">Loading...</span>!
        </h2>
        <p style="margin: 0; color: #64748b; font-size: 0.95rem;">Here's your teaching dashboard overview</p>
    </div>
</div>

<!-- Statistics Section -->
<div style="margin-bottom: 2rem;">
    <h3 style="color: #64748b; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1rem;">
        <i class="fas fa-chart-bar"></i> Teaching Overview
    </h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
        <div class="analytics-card">
            <div class="icon" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                <i class="fas fa-user-graduate" style="color: white;"></i>
            </div>
            <div class="label">Total Students</div>
            <div class="value" id="student-count">0</div>
            <div class="change positive">
                <i class="fas fa-users"></i> Enrolled
            </div>
        </div>

        <div class="analytics-card" onclick="location.href='activity.html'" style="cursor:pointer;">
            <div class="icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <i class="fas fa-tasks" style="color: white;"></i>
            </div>
            <div class="label">My Activities</div>
            <div class="value" id="activity-count">0</div>
            <div class="change positive">
                <i class="fas fa-list"></i> Created
            </div>
        </div>

        <div class="analytics-card" onclick="location.href='resources.html'" style="cursor:pointer;">
            <div class="icon" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                <i class="fas fa-book" style="color: white;"></i>
            </div>
            <div class="label">My Resources</div>
            <div class="value" id="resource-count">0</div>
            <div class="change positive">
                <i class="fas fa-folder"></i> Uploaded
            </div>
        </div>
    </div>
</div>

<!-- Grading Section -->
<div style="margin-bottom: 2rem;">
    <h3 style="color: #64748b; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1rem;">
        <i class="fas fa-clipboard-check"></i> Submissions & Grading
    </h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
        <div class="analytics-card">
            <div class="icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <i class="fas fa-clock" style="color: white;"></i>
            </div>
            <div class="label">Pending Grading</div>
            <div class="value" id="pending-grading">0</div>
            <div class="change" id="pending-status">
                <i class="fas fa-info-circle"></i> To grade
            </div>
        </div>

        <div class="analytics-card">
            <div class="icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <i class="fas fa-check-circle" style="color: white;"></i>
            </div>
            <div class="label">Graded</div>
            <div class="value" id="graded-count">0</div>
            <div class="change positive">
                <i class="fas fa-check"></i> Completed
            </div>
        </div>

        <div class="analytics-card">
            <div class="icon" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                <i class="fas fa-star" style="color: white;"></i>
            </div>
            <div class="label">Average Grade</div>
            <div class="value" id="avg-grade">0.0</div>
            <div class="change positive">
                <i class="fas fa-chart-line"></i> Class performance
            </div>
        </div>
    </div>
</div>

<!-- Recent Submissions -->
<div class="card">
    <h3 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
        <i class="fas fa-paper-plane" style="color: var(--primary-color);"></i>
        Recent Submissions
    </h3>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th><i class="fas fa-user"></i> Student</th>
                    <th><i class="fas fa-tasks"></i> Activity</th>
                    <th><i class="fas fa-calendar"></i> Submitted</th>
                    <th><i class="fas fa-info-circle"></i> Status</th>
                    <th style="text-align: center;"><i class="fas fa-cog"></i> Action</th>
                </tr>
            </thead>
            <tbody id="recent-submissions-tbody">
                <tr>
                    <td colspan="5" style="padding: 2rem; text-align: center; color: #64748b;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                        Loading...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

        </div>
    </div>
    
    <script src="../js/auth.js"></script>
    <script src="../js/script.js"></script>
    <script>
        const authManager = new AuthManager();

        async function loadDashboard() {
            try {
                // Check authentication
                const user = await authManager.requireAuth('teacher');
                if (!user) return;

                // Display user info
                document.getElementById('user-name').textContent = user.name;
                document.getElementById('user-avatar').textContent = user.initials;
                document.getElementById('profile-avatar').textContent = user.initials;

                // Load dashboard data
                const response = await fetch('/SOCSCI_3/api/teacher/dashboard.php');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load dashboard');
                }

                // Update statistics
                const stats = data.stats;
                document.getElementById('student-count').textContent = stats.student_count;
                document.getElementById('activity-count').textContent = stats.activity_count;
                document.getElementById('resource-count').textContent = stats.resource_count;
                document.getElementById('pending-grading').textContent = stats.pending_grading;
                document.getElementById('graded-count').textContent = stats.graded_count;
                document.getElementById('avg-grade').textContent = stats.avg_grade.toFixed(1);

                // Update pending status
                const pendingStatus = document.getElementById('pending-status');
                if (stats.pending_grading > 0) {
                    pendingStatus.className = 'change negative';
                    pendingStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Action needed';
                } else {
                    pendingStatus.className = 'change positive';
                    pendingStatus.innerHTML = '<i class="fas fa-check-circle"></i> All graded';
                }

                // Load recent submissions
                if (data.recent_submissions) {
                    const tbody = document.getElementById('recent-submissions-tbody');
                    if (data.recent_submissions.length > 0) {
                        tbody.innerHTML = data.recent_submissions.map(submission => {
                            const submittedDate = new Date(submission.submitted_at);
                            const statusBadge = submission.status === 'graded' ? 
                                '<span class="badge badge-success">Graded</span>' : 
                                '<span class="badge badge-warning">Pending</span>';
                            
                            return `
                                <tr>
                                    <td>${escapeHtml(submission.first_name)} ${escapeHtml(submission.last_name)}</td>
                                    <td>${escapeHtml(submission.activity_title)}</td>
                                    <td>
                                        <div style="display: flex; flex-direction: column;">
                                            <span>${formatDate(submittedDate)}</span>
                                            <small style="color: #64748b;">${formatTime(submittedDate)}</small>
                                        </div>
                                    </td>
                                    <td>${statusBadge}</td>
                                    <td style="text-align: center;">
                                        <a href="activity.html" class="btn" style="width: auto; padding: 0.5rem 1rem;">
                                            <i class="fas fa-${submission.status === 'graded' ? 'eye' : 'edit'}"></i> 
                                            ${submission.status === 'graded' ? 'View' : 'Grade'}
                                        </a>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" style="padding: 2rem; text-align: center; color: #64748b;">
                                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; display: block; opacity: 0.3;"></i>
                                    No recent submissions.
                                </td>
                            </tr>
                        `;
                    }
                }

            } catch (error) {
                console.error('Dashboard error:', error);
                alert('Failed to load dashboard: ' + error.message);
            }
        }

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', async function(e) {
            e.preventDefault();
            try {
                await authManager.logout();
                window.location.href = '/index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Helper functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
