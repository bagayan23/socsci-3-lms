<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Students - SOCSCI-3</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header>
        <div style="display:flex; align-items:center;">
            <i class="fas fa-bars burger-menu"></i>
            <h1>SOCSCI-3 Teacher Portal</h1>
        </div>
        <div class="header-user-menu">
            <div class="user-avatar" id="user-avatar"></div>
            <div class="dropdown-menu">
                <a href="edit_profile.html"><i class="fas fa-user-edit"></i> Edit Account</a>
                <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </header>
    
    <div class="dashboard-layout">
        <div class="sidebar">
            <nav>
                <ul>
                    <li><a href="dashboard.html">Home</a></li>
                    <li><a href="activity.html">Activity</a></li>
                    <li><a href="students.html">Students</a></li>
                    <li><a href="courses.html">Courses</a></li>
                    <li><a href="resources.html">Resources</a></li>
                </ul>
            </nav>
        </div>
        <div class="main-content">

<h2>Students</h2>

<input type="text" id="search-students" class="search-bar form-control" placeholder="Search students..." style="margin-bottom: 10px; max-width: 300px;">
<div class="table-wrapper">
<table id="students-table">
    <thead>
        <tr>
            <th>Student ID</th>
            <th>Name</th>
            <th>Program</th>
            <th>Year</th>
            <th>Submissions</th>
            <th>Avg Grade</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="students-tbody">
        <tr>
            <td colspan="7" style="padding: 2rem; text-align: center;">
                <div class="spinner" style="margin: 0 auto;"></div>
                Loading...
            </td>
        </tr>
    </tbody>
</table>
</div>

<!-- Student Details Modal -->
<div id="details-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <span class="close" onclick="closeDetailsModal()">&times;</span>
        <div id="student-details-container"></div>
    </div>
</div>

        </div>
    </div>
    
    <script src="../js/auth.js"></script>
    <script src="../js/script.js"></script>
    <script>
        const authManager = new AuthManager();

        async function loadStudents() {
            try {
                const user = await authManager.requireAuth('teacher');
                if (!user) return;

                document.getElementById('user-avatar').textContent = user.initials;

                const response = await fetch('/SOCSCI_3/api/teacher/students.php');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load students');
                }

                const tbody = document.getElementById('students-tbody');
                
                if (data.students.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="padding: 2rem; text-align: center; color: #64748b;">No students enrolled yet.</td></tr>';
                    return;
                }

                tbody.innerHTML = data.students.map(student => {
                    const avgGrade = student.avg_grade ? parseFloat(student.avg_grade).toFixed(2) : 'N/A';
                    
                    return `
                        <tr>
                            <td>${escapeHtml(student.student_id)}</td>
                            <td>${escapeHtml(student.first_name + ' ' + student.last_name)}</td>
                            <td>${escapeHtml(student.program || 'N/A')}</td>
                            <td>${escapeHtml(student.year_level || 'N/A')}</td>
                            <td>${student.total_submissions} (${student.graded_submissions} graded)</td>
                            <td><strong>${avgGrade}</strong></td>
                            <td>
                                <button onclick="viewStudentDetails(${student.id})" class="btn file-preview-btn">
                                    <i class="fas fa-eye"></i> <span>View Details</span>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                setupSearch();

            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load students: ' + error.message);
            }
        }

        async function viewStudentDetails(studentId) {
            try {
                const response = await fetch('/SOCSCI_3/api/teacher/students.php?student_id=' + studentId);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load student details');
                }

                const student = data.student;
                const submissions = data.submissions;
                const stats = data.stats;

                let detailsHTML = `
                    <h3>${escapeHtml(student.first_name + ' ' + student.last_name)}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 5px;">
                            <p style="color: #64748b; font-size: 0.875rem; margin: 0;">Student ID</p>
                            <p style="font-weight: 600; margin: 0.25rem 0 0 0;">${escapeHtml(student.student_id)}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 5px;">
                            <p style="color: #64748b; font-size: 0.875rem; margin: 0;">Program</p>
                            <p style="font-weight: 600; margin: 0.25rem 0 0 0;">${escapeHtml(student.program || 'N/A')}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 5px;">
                            <p style="color: #64748b; font-size: 0.875rem; margin: 0;">Year Level</p>
                            <p style="font-weight: 600; margin: 0.25rem 0 0 0;">${escapeHtml(student.year_level || 'N/A')}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 5px;">
                            <p style="color: #64748b; font-size: 0.875rem; margin: 0;">Email</p>
                            <p style="font-weight: 600; margin: 0.25rem 0 0 0; font-size: 0.875rem;">${escapeHtml(student.email)}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="stat-card">
                            <div class="stat-number">${stats.total_submissions}</div>
                            <div class="stat-label">Total Submissions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.graded_count}</div>
                            <div class="stat-label">Graded</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.pending_count}</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.avg_grade || 'N/A'}</div>
                            <div class="stat-label">Average Grade</div>
                        </div>
                    </div>
                    
                    <h4>Submission History</h4>
                `;

                if (submissions.length === 0) {
                    detailsHTML += '<p style="text-align: center; color: #64748b; padding: 2rem;">No submissions yet.</p>';
                } else {
                    detailsHTML += `
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Activity</th>
                                        <th>Type</th>
                                        <th>Teacher</th>
                                        <th>Submitted</th>
                                        <th>Grade</th>
                                        <th>Feedback</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${submissions.map(sub => `
                                        <tr>
                                            <td>${escapeHtml(sub.activity_title)}</td>
                                            <td>${escapeHtml(sub.activity_type)}</td>
                                            <td>${escapeHtml(sub.teacher_first_name + ' ' + sub.teacher_last_name)}</td>
                                            <td>${new Date(sub.submitted_at).toLocaleString()}</td>
                                            <td>${sub.grade ? `<strong>${escapeHtml(sub.grade)}</strong>` : '<span style="color: #f59e0b;">Pending</span>'}</td>
                                            <td>${sub.feedback ? escapeHtml(sub.feedback) : '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                document.getElementById('student-details-container').innerHTML = detailsHTML;
                document.getElementById('details-modal').style.display = 'flex';

            } catch (error) {
                alert('Failed to load student details: ' + error.message);
            }
        }

        function closeDetailsModal() {
            document.getElementById('details-modal').style.display = 'none';
        }

        function setupSearch() {
            const searchInput = document.getElementById('search-students');
            const tbody = document.getElementById('students-tbody');

            searchInput.addEventListener('keyup', function() {
                const filter = this.value.toLowerCase();
                const rows = tbody.getElementsByTagName('tr');

                for (let row of rows) {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(filter) ? '' : 'none';
                }
            });
        }

        document.getElementById('logout-btn').addEventListener('click', async function(e) {
            e.preventDefault();
            await authManager.logout();
            window.location.href = '/index.html';
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', loadStudents);
    </script>
</body>
</html>
