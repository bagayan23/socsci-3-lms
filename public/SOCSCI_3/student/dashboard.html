<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - SOCSCI-3</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>
<body>
    <header>
        <div style="display:flex; align-items:center;">
            <i class="fas fa-bars burger-menu"></i>
            <h1>SOCSCI-3 Student Portal</h1>
        </div>
        <div class="header-user-menu">
            <div class="user-avatar" id="user-avatar">
                <div class="spinner"></div>
            </div>
            <div class="dropdown-menu">
                <a href="edit_profile.html"><i class="fas fa-user-edit"></i> Edit Account</a>
                <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </header>
    
    <div class="dashboard-layout">
        <div class="sidebar">
            <nav>
                <ul>
                    <li><a href="dashboard.html">Home</a></li>
                    <li><a href="activity.html">Activity</a></li>
                    <li><a href="resources.html">Resources</a></li>
                </ul>
            </nav>
        </div>
        <div class="main-content">

<div style="margin-bottom: 2rem; display: flex; align-items: center; gap: 1.5rem;">
    <div style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; border: 3px solid var(--primary-color); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); flex-shrink: 0;">
        <div id="profile-avatar" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary-color), #818cf8); color: white; font-size: 2rem; font-weight: 600;">
        </div>
    </div>
    <div>
        <h2 style="margin: 0 0 0.5rem 0; color: var(--text-color); display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-graduation-cap" style="color: var(--primary-color);"></i>
            Welcome back, <span id="user-name">Loading...</span>!
        </h2>
        <p style="margin: 0; color: #64748b; font-size: 0.95rem;">Here's your academic progress overview</p>
    </div>
</div>

<!-- Progress Section -->
<div style="margin-bottom: 2rem;">
    <h3 style="color: #64748b; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1rem;">
        <i class="fas fa-chart-line"></i> My Progress
    </h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
        <div class="analytics-card">
            <div class="icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <i class="fas fa-check-circle" style="color: white;"></i>
            </div>
            <div class="label">Completed</div>
            <div class="value" id="submitted-count">0</div>
            <div class="progress-bar">
                <div class="progress-bar-fill" id="completion-bar" style="width: 0%"></div>
            </div>
            <small style="color: #64748b;"><span id="completion-rate">0</span>% completion rate</small>
        </div>

        <div class="analytics-card" onclick="location.href='activity.html'" style="cursor:pointer;">
            <div class="icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <i class="fas fa-clock" style="color: white;"></i>
            </div>
            <div class="label">Pending Activities</div>
            <div class="value" id="pending-count">0</div>
            <div class="change positive" id="pending-status">
                <i class="fas fa-check-circle"></i> All done!
            </div>
        </div>

        <div class="analytics-card">
            <div class="icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <i class="fas fa-clipboard-check" style="color: white;"></i>
            </div>
            <div class="label">Graded</div>
            <div class="value" id="graded-count">0</div>
            <div class="change positive">
                <i class="fas fa-check"></i> of <span id="submitted-count-2">0</span> submitted
            </div>
        </div>
    </div>
</div>

<!-- Performance Section -->
<div style="margin-bottom: 2rem;">
    <h3 style="color: #64748b; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1rem;">
        <i class="fas fa-trophy"></i> Performance & Resources
    </h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
        <div class="analytics-card">
            <div class="icon" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                <i class="fas fa-star" style="color: white;"></i>
            </div>
            <div class="label">Average Grade</div>
            <div class="value" id="avg-grade">0.0</div>
            <div class="change positive" id="grade-status">
                <i class="fas fa-thumbs-up"></i> Good
            </div>
        </div>

        <div class="analytics-card" onclick="location.href='resources.html'" style="cursor:pointer;">
            <div class="icon" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                <i class="fas fa-book-open" style="color: white;"></i>
            </div>
            <div class="label">Resources Available</div>
            <div class="value" id="resources-count">0</div>
            <div class="change positive">
                <i class="fas fa-folder-open"></i> Ready to view
            </div>
        </div>

        <div class="analytics-card" onclick="location.href='activity.html'" style="cursor:pointer;">
            <div class="icon" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                <i class="fas fa-tasks" style="color: white;"></i>
            </div>
            <div class="label">Total Activities</div>
            <div class="value" id="total-activities">0</div>
            <div class="change positive">
                <i class="fas fa-list"></i> Available
            </div>
        </div>
    </div>
</div>

<!-- Recent Grades -->
<div class="card" id="recent-grades-card" style="margin-bottom: 2rem; display: none;">
    <h3 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
        <i class="fas fa-trophy" style="color: var(--primary-color);"></i>
        Recent Grades
    </h3>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th><i class="fas fa-tasks"></i> Activity</th>
                    <th><i class="fas fa-star"></i> Grade</th>
                    <th><i class="fas fa-percentage"></i> Score</th>
                    <th><i class="fas fa-calendar"></i> Graded On</th>
                </tr>
            </thead>
            <tbody id="recent-grades-tbody">
            </tbody>
        </table>
    </div>
</div>

<!-- Upcoming Activities -->
<div class="card" style="margin-bottom: 2rem;">
    <h3 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
        <i class="fas fa-exclamation-circle" style="color: var(--warning-color);"></i>
        Upcoming Activities
    </h3>
    <input type="text" id="search-upcoming-activities" class="search-bar form-control" 
           placeholder="Search activities..." style="margin-bottom: 1rem; max-width: 400px;">
    
    <div class="table-wrapper">
        <table id="table-upcoming-activities">
            <thead>
                <tr>
                    <th><i class="fas fa-heading"></i> Title</th>
                    <th><i class="fas fa-tag"></i> Type</th>
                    <th><i class="fas fa-calendar"></i> Due Date</th>
                    <th><i class="fas fa-info-circle"></i> Status</th>
                    <th style="text-align: center;"><i class="fas fa-cog"></i> Action</th>
                </tr>
            </thead>
            <tbody id="upcoming-activities-tbody">
                <tr>
                    <td colspan="5" style="padding: 2rem; text-align: center; color: #64748b;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                        Loading...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

        </div>
    </div>
    
    <script src="../js/auth.js"></script>
    <script src="../js/script.js"></script>
    <script>
        const authManager = new AuthManager();

        async function loadDashboard() {
            try {
                // Check authentication
                const user = await authManager.requireAuth('student');
                if (!user) return;

                // Display user info
                document.getElementById('user-name').textContent = user.name;
                document.getElementById('user-avatar').textContent = user.initials;
                document.getElementById('profile-avatar').textContent = user.initials;

                // Load dashboard data
                const response = await fetch('/SOCSCI_3/api/student/dashboard.php');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load dashboard');
                }

                // Update statistics
                const stats = data.stats;
                document.getElementById('submitted-count').textContent = stats.submitted_count;
                document.getElementById('submitted-count-2').textContent = stats.submitted_count;
                document.getElementById('pending-count').textContent = stats.pending_count;
                document.getElementById('graded-count').textContent = stats.graded_count;
                document.getElementById('avg-grade').textContent = stats.avg_grade.toFixed(1);
                document.getElementById('resources-count').textContent = stats.resources_count;
                document.getElementById('total-activities').textContent = stats.total_activities;
                document.getElementById('completion-rate').textContent = stats.completion_rate;
                document.getElementById('completion-bar').style.width = stats.completion_rate + '%';

                // Update pending status
                const pendingStatus = document.getElementById('pending-status');
                if (stats.pending_count > 0) {
                    pendingStatus.className = 'change negative';
                    pendingStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Action needed';
                }

                // Update grade status
                const gradeStatus = document.getElementById('grade-status');
                if (stats.avg_grade >= 90) {
                    gradeStatus.innerHTML = '<i class="fas fa-thumbs-up"></i> Excellent!';
                } else if (stats.avg_grade >= 75) {
                    gradeStatus.innerHTML = '<i class="fas fa-thumbs-up"></i> Good';
                } else {
                    gradeStatus.className = 'change negative';
                    gradeStatus.innerHTML = '<i class="fas fa-info-circle"></i> Keep going!';
                }

                // Load recent grades
                if (data.recent_grades && data.recent_grades.length > 0) {
                    document.getElementById('recent-grades-card').style.display = 'block';
                    const tbody = document.getElementById('recent-grades-tbody');
                    tbody.innerHTML = data.recent_grades.map(grade => {
                        const percentage = (grade.grade / grade.total_score) * 100;
                        const badgeClass = percentage >= 90 ? 'badge-success' : (percentage >= 75 ? 'badge-info' : 'badge-warning');
                        const gradeDate = new Date(grade.graded_at);
                        
                        return `
                            <tr>
                                <td>${escapeHtml(grade.title)}</td>
                                <td>
                                    <span class="badge ${badgeClass}">
                                        ${parseFloat(grade.grade).toFixed(1)} / ${grade.total_score}
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div class="progress-bar" style="width: 100px;">
                                            <div class="progress-bar-fill" style="width: ${percentage}%"></div>
                                        </div>
                                        <span style="font-weight: 600;">${percentage.toFixed(1)}%</span>
                                    </div>
                                </td>
                                <td>
                                    <div style="display: flex; flex-direction: column;">
                                        <span>${formatDate(gradeDate)}</span>
                                        <small style="color: #64748b;">${formatTime(gradeDate)}</small>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                // Load upcoming activities
                if (data.upcoming_activities) {
                    const tbody = document.getElementById('upcoming-activities-tbody');
                    if (data.upcoming_activities.length > 0) {
                        tbody.innerHTML = data.upcoming_activities.map(activity => {
                            const dueDate = new Date(activity.due_date);
                            const statusBadge = activity.status === 'submitted' ? 
                                '<span class="badge badge-success">Submitted</span>' : 
                                '<span class="badge badge-warning">Pending</span>';
                            
                            return `
                                <tr>
                                    <td>${escapeHtml(activity.title)}</td>
                                    <td>
                                        <span class="badge badge-info">${escapeHtml(activity.type.charAt(0).toUpperCase() + activity.type.slice(1))}</span>
                                    </td>
                                    <td>
                                        <div style="display: flex; flex-direction: column;">
                                            <span>${formatDate(dueDate)}</span>
                                            <small style="color: #64748b;">${formatTime(dueDate)}</small>
                                        </div>
                                    </td>
                                    <td>${statusBadge}</td>
                                    <td style="text-align: center;">
                                        <a href="activity.html" class="btn" style="width: auto; padding: 0.5rem 1rem;">
                                            <i class="fas fa-${activity.status === 'submitted' ? 'eye' : 'pencil-alt'}"></i> 
                                            ${activity.status === 'submitted' ? 'View' : 'Answer'}
                                        </a>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" style="padding: 2rem; text-align: center; color: #64748b;">
                                    <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem; display: block; color: var(--success-color); opacity: 0.5;"></i>
                                    Great job! No upcoming activities.
                                </td>
                            </tr>
                        `;
                    }
                }

            } catch (error) {
                console.error('Dashboard error:', error);
                alert('Failed to load dashboard: ' + error.message);
            }
        }

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', async function(e) {
            e.preventDefault();
            try {
                await authManager.logout();
                window.location.href = '/index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Helper functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
