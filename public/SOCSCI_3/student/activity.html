<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Activities - SOCSCI-3</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>
<body>
    <header>
        <div style="display:flex; align-items:center;">
            <i class="fas fa-bars burger-menu"></i>
            <h1>SOCSCI-3 Student Portal</h1>
        </div>
        <div class="header-user-menu">
            <div class="user-avatar" id="user-avatar"></div>
            <div class="dropdown-menu">
                <a href="edit_profile.html"><i class="fas fa-user-edit"></i> Edit Account</a>
                <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </header>
    
    <div class="dashboard-layout">
        <div class="sidebar">
            <nav>
                <ul>
                    <li><a href="dashboard.html">Home</a></li>
                    <li><a href="activity.html">Activity</a></li>
                    <li><a href="resources.html">Resources</a></li>
                </ul>
            </nav>
        </div>
        <div class="main-content">

<h2>Activities & Quizzes</h2>

<div id="activities-container"></div>

        </div>
    </div>
    
    <script src="../js/auth.js"></script>
    <script src="../js/script.js"></script>
    <script>
        const authManager = new AuthManager();

        async function loadActivities() {
            try {
                const user = await authManager.requireAuth('student');
                if (!user) return;

                document.getElementById('user-avatar').textContent = user.initials;

                const response = await fetch('/SOCSCI_3/api/student/activities.php');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load activities');
                }

                const container = document.getElementById('activities-container');
                
                if (data.activities.length === 0) {
                    container.innerHTML = '<div class="card"><p style="text-align:center;color:#64748b;">No activities available yet.</p></div>';
                    return;
                }

                container.innerHTML = data.activities.map(activity => {
                    const isSubmitted = activity.submission_id !== null;
                    const isGraded = activity.grade !== null;
                    
                    return `
                        <div class="card" style="max-width: 100%; margin-top:0px; margin-bottom: 1rem;">
                            <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:1rem;">
                                <h3>${escapeHtml(activity.title)} <span style="font-size: 0.8em; color: #777;">(${activity.type.charAt(0).toUpperCase() + activity.type.slice(1)})</span></h3>
                                <span>Posted by: ${escapeHtml(activity.first_name + ' ' + activity.last_name)}</span>
                            </div>
                            <p>${escapeHtml(activity.description)}</p>
                            ${activity.file_path ? `
                                <p style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                    <span>Attachment:</span>
                                    <button onclick="previewFile('${escapeHtml(activity.file_path)}', '${escapeHtml(activity.original_filename || 'file')}')" class="btn file-preview-btn" title="View File">
                                        <i class="fas fa-eye"></i> <span>View File</span>
                                    </button>
                                </p>
                            ` : ''}
                            
                            <hr>

                            ${isSubmitted ? `
                                <div style="background-color: #e8f5e9; padding: 10px; border-radius: 5px;">
                                    <p><strong>Status:</strong> Submitted on ${new Date(activity.submitted_at).toLocaleString()}</p>
                                    ${isGraded ? `
                                        <p><strong>Grade:</strong> ${activity.grade}</p>
                                        <p><strong>Feedback:</strong> ${escapeHtml(activity.feedback || 'No feedback')}</p>
                                    ` : '<p><em>Pending Grade</em></p>'}
                                </div>
                            ` : `
                                <form onsubmit="submitActivity(event, ${activity.id})" id="form-${activity.id}">
                                    <div class="form-group">
                                        <label>Your Answer / Submission Text</label>
                                        <textarea name="text_submission" class="form-control" rows="3"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Attach File (if required)</label>
                                        <input type="file" name="file" class="form-control">
                                    </div>
                                    <button type="submit" class="btn">Submit Work</button>
                                </form>
                            `}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load activities: ' + error.message);
            }
        }

        async function submitActivity(event, activityId) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            formData.append('activity_id', activityId);

            try {
                const response = await fetch('/SOCSCI_3/api/student/activities.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    loadActivities(); // Reload
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Submit error:', error);
                alert('Failed to submit: ' + error.message);
            }
        }

        document.getElementById('logout-btn').addEventListener('click', async function(e) {
            e.preventDefault();
            await authManager.logout();
            window.location.href = '/index.html';
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', loadActivities);
    </script>
</body>
</html>
