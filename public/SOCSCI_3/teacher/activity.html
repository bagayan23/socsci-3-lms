<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Activities - SOCSCI-3</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>
<body>
    <header>
        <div style="display:flex; align-items:center;">
            <i class="fas fa-bars burger-menu"></i>
            <h1>SOCSCI-3 Teacher Portal</h1>
        </div>
        <div class="header-user-menu">
            <div class="user-avatar" id="user-avatar"></div>
            <div class="dropdown-menu">
                <a href="edit_profile.html"><i class="fas fa-user-edit"></i> Edit Account</a>
                <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </header>
    
    <div class="dashboard-layout">
        <div class="sidebar">
            <nav>
                <ul>
                    <li><a href="dashboard.html">Home</a></li>
                    <li><a href="activity.html">Activity</a></li>
                    <li><a href="students.html">Students</a></li>
                    <li><a href="courses.html">Courses</a></li>
                    <li><a href="resources.html">Resources</a></li>
                </ul>
            </nav>
        </div>
        <div class="main-content">

<h2>Activities & Quizzes</h2>

<button class="btn" onclick="showAddModal()" style="margin-bottom: 1rem;"><i class="fas fa-plus"></i> Create Activity</button>

<div id="activities-container"></div>

<!-- Add/Edit Activity Modal -->
<div id="activity-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close" onclick="closeActivityModal()">&times;</span>
        <h3 id="modal-title">Create Activity</h3>
        <form id="activity-form" onsubmit="saveActivity(event)">
            <input type="hidden" id="activity-id" name="activity_id">
            
            <div class="form-group">
                <label>Title *</label>
                <input type="text" id="title" name="title" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label>Type *</label>
                <select id="type" name="type" class="form-control" required>
                    <option value="assignment">Assignment</option>
                    <option value="quiz">Quiz</option>
                    <option value="exam">Exam</option>
                    <option value="project">Project</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Description *</label>
                <textarea id="description" name="description" class="form-control" rows="4" required></textarea>
            </div>
            
            <div class="form-group">
                <label>Attach File (optional)</label>
                <input type="file" id="file" name="file" class="form-control">
                <small id="current-file" style="display:none; color: #64748b;"></small>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" style="background-color: #64748b;" onclick="closeActivityModal()">Cancel</button>
                <button type="submit" class="btn">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- View Submissions Modal -->
<div id="submissions-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <span class="close" onclick="closeSubmissionsModal()">&times;</span>
        <h3 id="submissions-title">Submissions</h3>
        <div id="submissions-container"></div>
    </div>
</div>

<!-- Grade Submission Modal -->
<div id="grade-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close" onclick="closeGradeModal()">&times;</span>
        <h3>Grade Submission</h3>
        <form id="grade-form" onsubmit="submitGrade(event)">
            <input type="hidden" id="submission-id">
            
            <div id="submission-details" style="background-color: #f8fafc; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;"></div>
            
            <div class="form-group">
                <label>Grade *</label>
                <input type="text" id="grade" name="grade" class="form-control" required placeholder="e.g., 95, A, Pass">
            </div>
            
            <div class="form-group">
                <label>Feedback</label>
                <textarea id="feedback" name="feedback" class="form-control" rows="3" placeholder="Optional feedback for student"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" style="background-color: #64748b;" onclick="closeGradeModal()">Cancel</button>
                <button type="submit" class="btn">Submit Grade</button>
            </div>
        </form>
    </div>
</div>

        </div>
    </div>
    
    <script src="../js/auth.js"></script>
    <script src="../js/script.js"></script>
    <script>
        const authManager = new AuthManager();
        let currentActivityId = null;

        async function loadActivities() {
            try {
                const user = await authManager.requireAuth('teacher');
                if (!user) return;

                document.getElementById('user-avatar').textContent = user.initials;

                const response = await fetch('/SOCSCI_3/api/teacher/activity.php');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load activities');
                }

                const container = document.getElementById('activities-container');
                
                if (data.activities.length === 0) {
                    container.innerHTML = '<div class="card"><p style="text-align:center;color:#64748b;">No activities yet. Click "Create Activity" to add one.</p></div>';
                    return;
                }

                container.innerHTML = data.activities.map(activity => {
                    return `
                        <div class="card" style="margin-bottom: 1rem;">
                            <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:1rem;">
                                <h3>${escapeHtml(activity.title)} <span style="font-size: 0.8em; color: #777;">(${activity.type.charAt(0).toUpperCase() + activity.type.slice(1)})</span></h3>
                                <span style="color: #64748b;">${new Date(activity.created_at).toLocaleDateString()}</span>
                            </div>
                            <p>${escapeHtml(activity.description)}</p>
                            ${activity.file_path ? `
                                <p style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                    <span>Attachment:</span>
                                    <button onclick="previewFile('${escapeHtml(activity.file_path)}', '${escapeHtml(activity.original_filename || 'file')}')" class="btn file-preview-btn">
                                        <i class="fas fa-eye"></i> <span>View</span>
                                    </button>
                                </p>
                            ` : ''}
                            
                            <hr>
                            
                            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1rem;">
                                <div>
                                    <span style="color: #64748b;">Submissions: ${activity.total_submissions}</span>
                                    ${activity.pending_grading > 0 ? `<span style="color: #f59e0b; margin-left: 1rem;"><i class="fas fa-clock"></i> ${activity.pending_grading} pending</span>` : ''}
                                </div>
                                <div class="action-buttons-container">
                                    <button onclick="viewSubmissions(${activity.id})" class="btn file-preview-btn">
                                        <i class="fas fa-list"></i> <span>View Submissions</span>
                                    </button>
                                    <button onclick="editActivity(${activity.id})" class="btn file-preview-btn">
                                        <i class="fas fa-edit"></i> <span>Edit</span>
                                    </button>
                                    <button onclick="deleteActivity(${activity.id})" class="btn file-preview-btn" style="background-color: #ef4444;">
                                        <i class="fas fa-trash"></i> <span>Delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load activities: ' + error.message);
            }
        }

        function showAddModal() {
            document.getElementById('modal-title').textContent = 'Create Activity';
            document.getElementById('activity-form').reset();
            document.getElementById('activity-id').value = '';
            document.getElementById('current-file').style.display = 'none';
            document.getElementById('activity-modal').style.display = 'flex';
        }

        async function editActivity(id) {
            try {
                const response = await fetch('/SOCSCI_3/api/teacher/activity.php');
                const data = await response.json();
                
                const activity = data.activities.find(a => a.id === id);
                if (!activity) throw new Error('Activity not found');

                document.getElementById('modal-title').textContent = 'Edit Activity';
                document.getElementById('activity-id').value = activity.id;
                document.getElementById('title').value = activity.title;
                document.getElementById('type').value = activity.type;
                document.getElementById('description').value = activity.description;
                
                const currentFileEl = document.getElementById('current-file');
                if (activity.original_filename) {
                    currentFileEl.textContent = 'Current file: ' + activity.original_filename;
                    currentFileEl.style.display = 'block';
                } else {
                    currentFileEl.style.display = 'none';
                }
                
                document.getElementById('activity-modal').style.display = 'flex';
            } catch (error) {
                alert('Error loading activity: ' + error.message);
            }
        }

        async function saveActivity(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const activityId = document.getElementById('activity-id').value;
            
            if (activityId) {
                formData.append('_method', 'PUT');
            }

            try {
                const response = await fetch('/SOCSCI_3/api/teacher/activity.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    closeActivityModal();
                    loadActivities();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save activity: ' + error.message);
            }
        }

        async function deleteActivity(id) {
            if (!confirm('Are you sure you want to delete this activity? All submissions will also be deleted.')) {
                return;
            }

            try {
                const formData = new FormData();
                formData.append('_method', 'DELETE');
                formData.append('activity_id', id);

                const response = await fetch('/SOCSCI_3/api/teacher/activity.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    loadActivities();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete activity: ' + error.message);
            }
        }

        async function viewSubmissions(activityId) {
            currentActivityId = activityId;
            
            try {
                const response = await fetch('/SOCSCI_3/api/teacher/activity.php?activity_id=' + activityId);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load submissions');
                }

                const title = data.submissions.length > 0 ? data.submissions[0].activity_title : 'Submissions';
                document.getElementById('submissions-title').textContent = title + ' - Submissions';

                const container = document.getElementById('submissions-container');
                
                if (data.submissions.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#64748b;padding:2rem;">No submissions yet.</p>';
                } else {
                    container.innerHTML = `
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Submitted</th>
                                        <th>Grade</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.submissions.map(sub => `
                                        <tr>
                                            <td>${escapeHtml(sub.first_name + ' ' + sub.last_name)}<br><small style="color:#64748b;">${sub.student_id}</small></td>
                                            <td>${new Date(sub.submitted_at).toLocaleString()}</td>
                                            <td>${sub.grade ? `<strong>${escapeHtml(sub.grade)}</strong>` : '<span style="color:#f59e0b;">Pending</span>'}</td>
                                            <td>
                                                <div class="action-buttons-container">
                                                    ${sub.file_path ? `
                                                        <button onclick="previewFile('${escapeHtml(sub.file_path)}', '${escapeHtml(sub.first_name + ' ' + sub.last_name)}')" class="btn file-preview-btn" style="font-size:0.875rem;">
                                                            <i class="fas fa-eye"></i> <span>View</span>
                                                        </button>
                                                    ` : ''}
                                                    <button onclick="showGradeModal(${sub.id}, '${escapeHtml(sub.first_name + ' ' + sub.last_name)}', '${escapeHtml(sub.text_submission || '')}', '${escapeHtml(sub.grade || '')}', '${escapeHtml(sub.feedback || '')}')" class="btn file-preview-btn" style="background-color:#10b981; font-size:0.875rem;">
                                                        <i class="fas fa-check"></i> <span>${sub.grade ? 'Regrade' : 'Grade'}</span>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                document.getElementById('submissions-modal').style.display = 'flex';
            } catch (error) {
                alert('Failed to load submissions: ' + error.message);
            }
        }

        function showGradeModal(submissionId, studentName, textSubmission, currentGrade, currentFeedback) {
            document.getElementById('submission-id').value = submissionId;
            document.getElementById('grade').value = currentGrade;
            document.getElementById('feedback').value = currentFeedback;
            
            let detailsHTML = `<p><strong>Student:</strong> ${escapeHtml(studentName)}</p>`;
            if (textSubmission) {
                detailsHTML += `<p><strong>Answer:</strong><br>${escapeHtml(textSubmission)}</p>`;
            }
            document.getElementById('submission-details').innerHTML = detailsHTML;
            
            document.getElementById('grade-modal').style.display = 'flex';
        }

        async function submitGrade(event) {
            event.preventDefault();
            
            const submissionId = document.getElementById('submission-id').value;
            const grade = document.getElementById('grade').value;
            const feedback = document.getElementById('feedback').value;

            try {
                const formData = new FormData();
                formData.append('submission_id', submissionId);
                formData.append('grade', grade);
                formData.append('feedback', feedback);

                const response = await fetch('/SOCSCI_3/api/teacher/activity.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    closeGradeModal();
                    viewSubmissions(currentActivityId);
                    loadActivities();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to submit grade: ' + error.message);
            }
        }

        function closeActivityModal() {
            document.getElementById('activity-modal').style.display = 'none';
        }

        function closeSubmissionsModal() {
            document.getElementById('submissions-modal').style.display = 'none';
        }

        function closeGradeModal() {
            document.getElementById('grade-modal').style.display = 'none';
        }

        document.getElementById('logout-btn').addEventListener('click', async function(e) {
            e.preventDefault();
            await authManager.logout();
            window.location.href = '/index.html';
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', loadActivities);
    </script>
</body>
</html>
